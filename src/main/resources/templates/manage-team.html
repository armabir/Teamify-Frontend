<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Manage ' + ${team.name} + ' | Teamify'">Manage Team</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="/css/teams.css">
    <link rel="stylesheet" href="/css/manage-team.css">
</head>
<body>

<aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <i class="fas fa-users-cog"></i>
            <span class="sidebar-logo-text">Teamify</span>
        </div>
        <button id="sidebar-close" class="sidebar-close-btn"><i class="fas fa-times"></i></button>
    </div>
    <nav class="sidebar-nav">
        <a href="/profile" class="sidebar-link"><i class="fas fa-user"></i><span>Profile</span></a>
        <a href="/dashboard" class="sidebar-link"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
        <a href="/discover" class="sidebar-link"><i class="fas fa-compass"></i><span>Discover</span></a>
        <a href="/teams" class="sidebar-link active"><i class="fas fa-users"></i><span>Teams</span></a>
        <a href="/events" class="sidebar-link"><i class="fas fa-calendar-alt"></i><span>Events</span></a>
    </nav>
</aside>

<button id="sidebar-toggle" class="sidebar-toggle-btn"><i class="fas fa-bars"></i></button>
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<div class="page-wrapper">
    <main class="main-content">

        <header class="team-manage-header">
            <div class="team-cover" th:style="${team.coverImageUrl != null} ? 'background-image: url(' + ${team.coverImageUrl} + ');' : ''">
                <div class="cover-overlay"></div>
            </div>

            <div class="team-header-content">
                <div class="header-details">
                    <h1 th:text="${team.name}">Team Name</h1>
                    <p class="team-goal"><i class="fas fa-bullseye"></i> <span th:text="${team.goal}">Goal</span></p>

                    <p class="team-desc-header" th:text="${team.description}">Description...</p>

                    <div class="team-meta-header">
                        <span><i class="fas fa-calendar"></i> Founded: <span th:text="${team.createAt}">Date</span></span>
                        <span><i class="fas fa-users"></i> <span th:text="${#lists.size(team.memberUsernames)}">0</span> Members</span>
                    </div>

                    <form th:action="@{/join-team}" method="post" th:if="${!isMember}" style="margin-bottom: 1.5rem;">
                        <input type="hidden" name="teamName" th:value="${team.name}">
                        <button type="submit" class="btn-gradient">
                            <i class="fas fa-sign-in-alt"></i> Join Team
                        </button>
                    </form>
                </div>

                <div class="team-tabs">
                    <button class="tab-btn"
                            th:if="${isMember}"
                            th:classappend="${isMember} ? 'active' : ''"
                            onclick="openTab(event, 'tab-announcements')">
                        Announcements
                    </button>

                    <button class="tab-btn"
                            th:classappend="${!isMember} ? 'active' : ''"
                            onclick="openTab(event, 'tab-members')">
                        Members
                    </button>

                    <button class="tab-btn"
                            th:if="${isMember}"
                            onclick="openTab(event, 'tab-settings')">
                        Settings
                    </button>
                </div>
            </div>
        </header>

        <section id="tab-announcements" class="tab-content"
                 th:if="${isMember}"
                 th:classappend="${isMember} ? 'active' : ''">

            <div class="section-header-row">
                <h2>Team Updates</h2>
                <button class="btn-gradient" onclick="openModal('modal-announcement')">
                    <i class="fas fa-bullhorn"></i> New Announcement
                </button>
            </div>

            <div class="announcement-feed">
                <div class="glass-card announcement-card" th:each="msg : ${announcements}">
                    <div class="announcement-header">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span class="announcer-name"><i class="fas fa-user-circle"></i> Admin</span>
                            <span class="announcement-date"><i class="far fa-clock"></i> Posted</span>
                        </div>
                    </div>
                    <p class="announcement-text" th:text="${msg}">Message...</p>
                </div>

                <div class="empty-state" th:if="${#lists.isEmpty(announcements)}">
                    <div class="empty-icon-container"><i class="fas fa-bullhorn"></i></div>
                    <h3>No updates yet</h3>
                    <p>Post an announcement to keep your team informed.</p>
                </div>
            </div>
        </section>

        <section id="tab-members" class="tab-content"
                 th:classappend="${!isMember} ? 'active' : ''">

            <div class="section-header-row">
                <h2>Team Members</h2>
                <button class="btn-gradient" onclick="openModal('modal-add-member')" th:if="${isMember}">
                    <i class="fas fa-user-plus"></i> Invite Member
                </button>
            </div>

            <div class="members-grid">
                <div class="glass-card member-card" th:each="member : ${teamMembers}">

                    <span class="member-role-badge"
                          th:text="${member.userName == team.createdBy ? 'Owner' : 'Member'}"
                          th:classappend="${member.userName == team.createdBy ? 'owner' : 'member'}">
                    </span>

                    <div class="member-card-top">
                        <div class="member-pfp-container">
                            <img th:if="${member.profilePictureUrl != null}" th:src="${member.profilePictureUrl}" class="member-pfp">
                            <div th:unless="${member.profilePictureUrl != null}" class="member-pfp-placeholder">
                                <span th:text="${#strings.substring(member.firstName,0,1)}">U</span>
                            </div>
                        </div>

                        <div class="member-identity">
                            <h3 th:text="${member.firstName + ' ' + member.lastName}">Name</h3>
                            <span class="member-username" th:text="'@' + ${member.userName}">@user</span>
                        </div>
                    </div>

                    <div class="member-skills">
                        <span class="skill-tag-pill" th:each="skill : ${member.skills}" th:text="${skill.name}">Skill</span>
                        <span class="empty-skills-text" th:if="${member.skills == null or member.skills.isEmpty()}">No skills listed</span>
                    </div>

                    <div class="member-actions">
                        <a th:href="@{/profile(view=${member.userName})}" class="btn-view-profile-gradient">View Profile</a>

                        <form th:action="@{/remove-member}" method="post"
                              th:if="${isMember and member.userName != team.createdBy}"
                              style="display:inline;">

                            <input type="hidden" name="teamName" th:value="${team.name}">
                            <input type="hidden" name="username" th:value="${member.userName}">

                            <button type="submit" class="btn-icon-outline danger" title="Remove Member"
                                    onclick="return confirm('Are you sure you want to remove this member?');">
                                <i class="fas fa-times"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-settings" class="tab-content" th:if="${isMember}">
            <div class="glass-card settings-card">
                <h3>Visual Settings</h3>
                <form th:action="@{/manage-team/update-cover}" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="teamName" th:value="${team.name}">
                    <div class="form-group">
                        <label>Update Cover Image</label>
                        <input type="file" name="coverImage" class="form-input" accept="image/*">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-save">Upload Cover</button>
                    </div>
                </form>

                <hr style="border-color: rgba(255,255,255,0.1); margin: 2rem 0;">

                <h3>Team Details</h3>
                <form>
                    <div class="form-group">
                        <label>Team Name</label>
                        <input type="text" class="form-input" th:value="${team.name}" disabled style="opacity: 0.6; cursor: not-allowed;" title="Name change disabled">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-input" rows="4" th:text="${team.description}"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-save" style="opacity: 0.5;">Save Changes (Coming Soon)</button>
                    </div>
                </form>
            </div>
        </section>

    </main>
</div>

<div id="modal-announcement" class="modal-overlay" th:if="${isMember}">
    <div class="glass-card modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Post Announcement</h3>
            <button class="modal-close" onclick="closeModal('modal-announcement')"><i class="fas fa-times"></i></button>
        </div>
        <form th:action="@{/add-announcement}" method="post">
            <input type="hidden" name="teamName" th:value="${team.name}">
            <div class="form-group">
                <label>Message</label>
                <textarea name="announcement" class="form-input" rows="5" placeholder="Share an update..." required></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('modal-announcement')">Cancel</button>
                <button type="submit" class="btn-save">Post Update</button>
            </div>
        </form>
    </div>
</div>

<div id="modal-add-member" class="modal-overlay" th:if="${isMember}">
    <div class="glass-card modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Invite Member</h3>
            <button class="modal-close" onclick="closeModal('modal-add-member')"><i class="fas fa-times"></i></button>
        </div>
        <form th:action="@{/add-member}" method="post">
            <input type="hidden" name="teamName" th:value="${team.name}">
            <div class="form-group">
                <label>Username</label>
                <input type="text" name="username" class="form-input" placeholder="Enter username..." required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('modal-add-member')">Cancel</button>
                <button type="submit" class="btn-save">Invite</button>
            </div>
        </form>
    </div>
</div>

<script src="/js/teams.js"></script>
<script>
    // Tab Switching Logic
    function openTab(evt, tabName) {
        var i, tabContent, tabBtns;

        // Hide all tab contents
        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
            tabContent[i].classList.remove("active");
        }

        // Remove active class from buttons
        tabBtns = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tabBtns.length; i++) {
            tabBtns[i].className = tabBtns[i].className.replace(" active", "");
        }

        // Show current tab
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";

        // Add animation class
        setTimeout(() => {
            document.getElementById(tabName).classList.add("active");
        }, 10);
    }

    // Modal Helpers
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>